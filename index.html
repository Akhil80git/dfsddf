<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí Protected Originals ¬∑ Fixed Proxy Mode</title>
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --nav-width: 200px;
            --bg-light: #f4f7fc;
            --bg-dark: #1a1e24;
            --card-light: #ffffff;
            --card-dark: #2a2f38;
            --text-light: #1e2a3a;
            --text-dark: #f0f4fa;
            --text-muted-light: #5e6e84;
            --text-muted-dark: #a0b3cc;
            --border-light: #dee6f0;
            --border-dark: #404854;
            --response-bg-light: #1e262f;
            --response-bg-dark: #0b0f14;
            --response-text-light: #c0d0e0;
            --response-text-dark: #e0e8f0;
            --line-login: #ff6b6b;
            --line-register: #4ecdc4;
            --line-otp: #ffe66d;
            --line-verify: #b380aa;
            --line-profile: #6c5ce7;
            --line-update: #f9ca7f;
            --line-refresh: #a3c4f3;
            --line-forget: #cfb784;
            --line-logout: #ff9f1c;
            --line-reset: #2e86ab;
            --line-default: #a0a0a0;
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            transition: background-color 0.2s, color 0.2s;
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }
        
        /* Dark mode text fixes */
        body.dark-mode .api-row {
            background: var(--card-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        body.dark-mode .api-nav {
            background: var(--card-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        body.dark-mode .nav-item {
            color: var(--text-dark);
        }
        body.dark-mode .nav-header {
            color: var(--text-muted-dark);
            border-bottom-color: #3a4355;
        }
        body.dark-mode .url-box {
            background: #1e2530;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        body.dark-mode .auth-panel {
            background: #232933;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        body.dark-mode .request-textarea {
            background: #1e2530;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        body.dark-mode .global-base {
            background: #2d3440;
            color: var(--text-dark);
        }
        body.dark-mode .method-post {
            background: #1a3150;
            color: #a0c8ff;
        }
        body.dark-mode .method-get {
            background: #1a3a2a;
            color: #8fdcb0;
        }
        body.dark-mode .method-put {
            background: #3f351f;
            color: #ffe29c;
        }
        body.dark-mode .method-delete {
            background: #3f2320;
            color: #ffb4aa;
        }
        body.dark-mode .auth-collapse-btn {
            background: #2d3440;
            border-color: #4d5a70;
            color: #c7dbff;
        }
        body.dark-mode .duplicate-btn {
            background: #2d3b54;
            border-color: #5a6f8f;
            color: #c7dbff;
        }
        body.dark-mode .response-pre {
            background: var(--response-bg-dark);
            color: var(--response-text-dark);
        }
        body.dark-mode .text-secondary {
            color: var(--text-muted-dark) !important;
        }
        
        .app-layout {
            display: flex;
            gap: 1.2rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        .api-nav {
            width: var(--nav-width);
            flex-shrink: 0;
            background: white;
            border-radius: 24px;
            padding: 1rem 0.3rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04);
            height: fit-content;
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.05);
            transition: background-color 0.2s;
        }
        .nav-header {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c7e9a;
            padding: 0 0.8rem 0.6rem 0.8rem;
            border-bottom: 1px solid #e2e9f2;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.8rem;
            margin: 0.1rem 0.2rem;
            border-radius: 30px;
            color: #2f3f57;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.15s;
            border-left: 4px solid transparent;
        }
        .nav-item i { margin-right: 8px; width: 18px; }
        .nav-item:hover { background: #e3ecf7; }
        body.dark-mode .nav-item:hover { background: #364153; }
        .nav-item.active { background: #0d6efd; color: white; }
        .nav-item.protected {
            opacity: 0.9;
            border-left-width: 6px;
        }
        
        .content-area { flex-grow: 1; min-width: 0; }
        
        .api-row {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 8px 22px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.04);
            border-left-width: 6px;
            border-left-style: solid;
            transition: all 0.2s;
        }
        .api-row.protected {
            background: linear-gradient(to right, rgba(255,255,255,0.5), white);
        }
        body.dark-mode .api-row.protected {
            background: linear-gradient(to right, rgba(42,47,56,0.8), var(--card-dark));
        }
        
        /* Group colors */
        .api-row[data-group="login"] { border-left-color: #ff6b6b; }
        .api-row[data-group="register"] { border-left-color: #4ecdc4; }
        .api-row[data-group="otp"] { border-left-color: #ffe66d; }
        .api-row[data-group="verify"] { border-left-color: #b380aa; }
        .api-row[data-group="profile"] { border-left-color: #6c5ce7; }
        .api-row[data-group="update"] { border-left-color: #f9ca7f; }
        .api-row[data-group="refresh"] { border-left-color: #a3c4f3; }
        .api-row[data-group="forget"] { border-left-color: #cfb784; }
        .api-row[data-group="logout"] { border-left-color: #ff9f1c; }
        .api-row[data-group="reset"] { border-left-color: #2e86ab; }
        .api-row[data-group="default"] { border-left-color: #a0a0a0; }
        
        .method-badge {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 5px 16px;
            border-radius: 40px;
            min-width: 80px;
            text-align: center;
            display: inline-block;
        }
        .method-post { background: #e7f3ff; color: #084298; }
        .method-get { background: #e2f1e5; color: #0a4e2e; }
        .method-put { background: #fff2db; color: #664d03; }
        .method-delete { background: #fae1df; color: #94170c; }
        
        .url-box {
            background: #f7fafd;
            padding: 8px 18px;
            border-radius: 40px;
            border: 1px solid #e1eaf2;
            font-family: 'SF Mono', monospace;
        }
        .auth-panel {
            background: #f8fbfe;
            border-radius: 20px;
            padding: 1rem 1.3rem;
            margin: 1rem 0;
            border: 1px solid #dae2ed;
        }
        .response-pre {
            background: var(--response-bg-light);
            color: var(--response-text-light);
            padding: 1.2rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            min-height: 80px;
            max-height: none;
            height: auto;
            overflow: visible;
            border: 1px solid #303b48;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .request-textarea {
            background: #fafcff;
            border-radius: 20px;
            padding: 12px 16px;
            border: 2px solid #e2ebf5;
            width: 100%;
            resize: vertical;
            min-height: 80px;
            max-height: none;
            height: auto;
            overflow-y: hidden;
            font-family: monospace;
        }
        .port-input {
            max-width: 100px;
            border-radius: 40px;
            border: 2px solid #dee2e6;
            padding: 8px 16px;
        }
        .fixed-url {
            background: #e2eaf3;
            border-radius: 40px;
            padding: 8px 20px;
            font-weight: 500;
            border: 2px solid #6c5ce7;
            color: #2d3748;
            font-family: monospace;
            user-select: all;
        }
        body.dark-mode .fixed-url {
            background: #2d3440;
            color: #a0b3cc;
            border-color: #8a7be7;
        }
        .btn-send {
            border-radius: 40px;
            padding: 10px 28px;
            font-weight: 600;
        }
        .global-base {
            background: #e2eaf3;
            border-radius: 40px;
            padding: 6px 20px;
            font-weight: 500;
        }
        .theme-toggle {
            border-radius: 40px;
            padding: 8px 18px;
            background: white;
            border: 2px solid #dee2e6;
            cursor: pointer;
        }
        .refresh-all-btn {
            border-radius: 40px;
            padding: 8px 20px;
            background: #6c5ce7;
            color: white;
            border: none;
            font-weight: 600;
            margin-left: 10px;
        }
        .protected-badge {
            font-size: 0.7rem;
            padding: 2px 10px;
            border-radius: 30px;
            background: #ffd700;
            color: #1e2a3a;
            margin-left: 10px;
        }
        body.dark-mode .protected-badge {
            background: #b8860b;
            color: white;
        }
        .action-btn {
            border-radius: 30px;
            padding: 5px 12px;
            font-size: 0.8rem;
            margin-left: 4px;
        }
        .remove-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .url-badge {
            background: #6c5ce7;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        .backend-toggle {
            display: flex;
            gap: 10px;
            background: #f0f4fa;
            border-radius: 40px;
            padding: 4px;
        }
        .backend-option {
            padding: 6px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .backend-option.active {
            background: #6c5ce7;
            color: white;
        }
        body.dark-mode .backend-toggle {
            background: #2d3440;
        }
        .target-backend-input {
            max-width: 200px;
            border-radius: 40px;
            border: 2px solid #6c5ce7;
            padding: 6px 16px;
            background: white;
        }
        body.dark-mode .target-backend-input {
            background: #2d3440;
            color: white;
            border-color: #8a7be7;
        }
    </style>
</head>
<body class="p-4">

<!-- top bar - Fixed backend URL and separate port input -->
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4" style="max-width: 1600px; margin: 0 auto;">
    <div class="d-flex gap-3 align-items-center">
        <span class="bg-white shadow-sm rounded-5 p-3 d-inline-flex align-items-center px-4">
            <i class="bi bi-shield-check text-primary fs-3 me-2"></i>
            <span class="fw-bold fs-4">ProtectedAPI</span>
            <span class="badge bg-dark text-white ms-3 px-3 py-2 rounded-pill">PROXY FIXED ‚úÖ</span>
        </span>
    </div>
    <div class="d-flex align-items-center gap-2 mt-2 mt-sm-0 flex-wrap">
        <!-- Backend Toggle Switch -->
        <div class="backend-toggle" id="backendToggle">
            <div class="backend-option active" data-backend="fixed">
                <i class="bi bi-server"></i> Proxy Mode
            </div>
            <div class="backend-option" data-backend="local">
                <i class="bi bi-hdd"></i> Direct Mode
            </div>
        </div>
        
        <!-- Fixed Backend URL Display -->
        <div class="fixed-url d-flex align-items-center gap-2" id="fixedBackendDiv">
            <i class="bi bi-shield-check"></i>
            <span id="fixedBackendUrl">https://proxy-server-enne.onrender.com</span>
        </div>
        
        <!-- Target Backend Input (for proxy mode) -->
        <div class="d-flex align-items-center gap-1" id="targetBackendDiv">
            <span class="text-secondary">Target:</span>
            <input type="text" id="targetBackendInput" class="form-control target-backend-input" value="https://your-backend.onrender.com" placeholder="backend URL">
        </div>
        
        <!-- Local Port Input - Only visible when local selected -->
        <div class="d-flex align-items-center gap-1" id="localPortDiv" style="display: none;">
            <span class="text-secondary">Port:</span>
            <input type="number" id="portInput" class="form-control port-input" value="5000" min="1" max="65535" placeholder="port">
        </div>
        
        <button class="theme-toggle" id="themeToggleBtn">
            <i class="bi bi-sun-fill" id="themeIcon"></i>
        </button>
        <button class="refresh-all-btn" id="refreshAllBtn">
            <i class="bi bi-arrow-counterclockwise"></i> Clear JSON
        </button>
    </div>
</div>

<!-- main layout -->
<div class="app-layout">
    <!-- VERTICAL NAV -->
    <div class="api-nav" id="verticalNav">
        <div class="nav-header"><i class="bi bi-list-ul me-1"></i> ENDPOINTS</div>
        <div id="navItemsContainer"></div>
        <div class="nav-item" id="addApiNavBtn" style="margin-top: 8px;">
            <i class="bi bi-plus-circle"></i> Add new
        </div>
    </div>

    <!-- content area -->
    <div class="content-area">
        <div id="apiCardsContainer"></div>
        <div class="text-center mt-4 text-secondary small">
            <i class="bi bi-shield-lock-fill"></i> <span class="fw-bold">Original APIs (with badge) cannot be deleted</span> ¬∑ Duplicates & custom APIs are deletable
            <br>
            <span class="mt-2 d-block"><i class="bi bi-arrow-left-right"></i> <strong>Proxy Mode:</strong> Request goes via proxy ‚Üí target backend (CORS bypass) | <strong>Direct Mode:</strong> Direct to localhost</span>
            <span class="d-block"><i class="bi bi-info-circle"></i> In Proxy Mode, set your real backend URL in the "Target" field</span>
        </div>
    </div>
</div>

<script>
    (function() {
        // Proxy server URL - fixed
        const PROXY_SERVER_URL = 'https://proxy-server-enne.onrender.com';
        const PROXY_ENDPOINT = PROXY_SERVER_URL + '/proxy';  // Full proxy endpoint
        
        // Current backend mode: 'fixed' or 'local'
        let currentBackendMode = 'fixed'; // Default to proxy mode
        
        // Original API names that are protected (cannot be deleted)
        const PROTECTED_NAMES = [
            'üîµ Login',
            'üìÑ Register',
            'üè† OTP',
            '‚úÖ Verify OTP',
            'üìä Profile',
            'üîÑ Update',
            'üìÇ Refresh',
            'üíª Forget',
            'üëâ logout',
            'üîí Reset password'
        ];

        // Group colors mapping
        const GROUP_COLORS = {
            'üîµ Login': 'login',
            'üìÑ Register': 'register',
            'üè† OTP': 'otp',
            '‚úÖ Verify OTP': 'verify',
            'üìä Profile': 'profile',
            'üîÑ Update': 'update',
            'üìÇ Refresh': 'refresh',
            'üíª Forget': 'forget',
            'üëâ logout': 'logout',
            'üîí Reset password': 'reset'
        };

        // Default APIs with group info
        const DEFAULT_APIS = [
            { name: 'üîµ Login', method: 'POST', path: '/api/auth/login', description: 'authenticate', body: '{\n  "email": "user@example.com",\n  "password": "123456"\n}', auth: { type: 'none', token: '' }, contentType: 'application/json', showAuth: false, group: 'login', protected: true },
            { name: 'üìÑ Register', method: 'POST', path: '/api/auth/register', description: 'sign up', body: '{\n  "username": "test",\n  "email": "test@a.com",\n  "password": "secret"\n}', auth: { type: 'none', token: '' }, contentType: 'application/json', showAuth: false, group: 'register', protected: true },
            { name: 'üè† OTP', method: 'POST', path: '/api/auth/otp', description: 'request code', body: '{\n  "phone": "+919999999999"\n}', auth: { type: 'none', token: '' }, contentType: 'application/json', showAuth: false, group: 'otp', protected: true },
            { name: '‚úÖ Verify OTP', method: 'POST', path: '/api/auth/verify-otp', description: 'submit OTP', body: '{\n  "email": "zancyverma@gmail.com",\n  "otp": "798269"\n}', auth: { type: 'none', token: '' }, contentType: 'application/json', showAuth: false, group: 'verify', protected: true },
            { name: 'üìä Profile', method: 'GET', path: '/api/user/profile', description: 'get my profile', body: '', auth: { type: 'bearer', token: '' }, contentType: 'application/json', showAuth: false, group: 'profile', protected: true },
            { name: 'üîÑ Update', method: 'PUT', path: '/api/user/update', description: 'edit profile', body: '{\n  "fullName": "John Doe"\n}', auth: { type: 'bearer', token: '' }, contentType: 'application/json', showAuth: false, group: 'update', protected: true },
            { name: 'üìÇ Refresh', method: 'POST', path: '/api/auth/refresh', description: 'new access token', body: '{\n  "refreshToken": "your_refresh_here"\n}', auth: { type: 'none', token: '' }, contentType: 'application/json', showAuth: false, group: 'refresh', protected: true },
            { name: 'üíª Forget', method: 'POST', path: '/api/auth/forgot', description: 'reset password email', body: '{\n  "email": "forgot@ex.com"\n}', auth: { type: 'none', token: '' }, contentType: 'application/json', showAuth: false, group: 'forget', protected: true },
            { name: 'üëâ logout', method: 'POST', path: '/api/auth/logout', description: 'sign out', body: '', auth: { type: 'bearer', token: '' }, contentType: 'application/json', showAuth: false, group: 'logout', protected: true },
            { name: 'üîí Reset password', method: 'POST', path: '/api/auth/reset', description: 'set new password', body: '{\n  "newPassword": "newpass123"\n}', auth: { type: 'none', token: '' }, contentType: 'application/json', showAuth: false, group: 'reset', protected: true }
        ];

        function loadApis() {
            const saved = localStorage.getItem('protectedApiData');
            if (saved) {
                try { 
                    const parsed = JSON.parse(saved);
                    // Ensure protected field exists
                    parsed.forEach(api => {
                        if (!api.group) {
                            const baseName = api.name.replace(/\s*\(copy\)\s*/g, '').trim();
                            api.group = GROUP_COLORS[baseName] || 'default';
                        }
                        // If it's an original (name in PROTECTED_NAMES and no '(copy)'), mark protected
                        if (PROTECTED_NAMES.includes(api.name) && !api.name.includes('(copy)')) {
                            api.protected = true;
                        } else {
                            api.protected = false;
                        }
                    });
                    return parsed;
                } catch (e) {}
            }
            return JSON.parse(JSON.stringify(DEFAULT_APIS));
        }

        function saveApis(apis) {
            localStorage.setItem('protectedApiData', JSON.stringify(apis));
        }

        let customApis = loadApis();
        let responseMap = new Map();

        const container = document.getElementById('apiCardsContainer');
        const navContainer = document.getElementById('navItemsContainer');
        const portInput = document.getElementById('portInput');
        const addApiNavBtn = document.getElementById('addApiNavBtn');
        const themeToggle = document.getElementById('themeToggleBtn');
        const themeIcon = document.getElementById('themeIcon');
        const refreshAllBtn = document.getElementById('refreshAllBtn');
        const fixedBackendDiv = document.getElementById('fixedBackendDiv');
        const targetBackendDiv = document.getElementById('targetBackendDiv');
        const localPortDiv = document.getElementById('localPortDiv');
        const backendOptions = document.querySelectorAll('.backend-option');
        const targetBackendInput = document.getElementById('targetBackendInput');

        // Default target backend - CHANGE THIS TO YOUR ACTUAL BACKEND URL
        targetBackendInput.value = 'https://your-backend.onrender.com'; // üëà CHANGE THIS!

        // Backend toggle functionality
        backendOptions.forEach(option => {
            option.addEventListener('click', () => {
                backendOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                
                currentBackendMode = option.dataset.backend;
                
                if (currentBackendMode === 'fixed') {
                    fixedBackendDiv.style.display = 'flex';
                    targetBackendDiv.style.display = 'flex';
                    localPortDiv.style.display = 'none';
                } else {
                    fixedBackendDiv.style.display = 'none';
                    targetBackendDiv.style.display = 'none';
                    localPortDiv.style.display = 'flex';
                }
                
                // Re-render cards to show updated URLs
                renderCards();
                renderNav();
            });
        });

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-stars-fill');
            } else {
                themeIcon.classList.remove('bi-moon-stars-fill');
                themeIcon.classList.add('bi-sun-fill');
            }
        });

        // GLOBAL REFRESH - clears only JSON body data
        refreshAllBtn.addEventListener('click', () => {
            customApis.forEach(api => {
                api.body = '';
            });
            responseMap.clear();
            saveApis(customApis);
            renderCards();
            renderNav();
        });

        function getCurrentBaseUrl() {
            if (currentBackendMode === 'fixed') {
                return PROXY_SERVER_URL;  // Just for display purposes
            } else {
                let port = portInput.value.trim();
                if (!port || isNaN(port) || port <= 0) port = 5000;
                return `http://localhost:${port}`;
            }
        }

        function resolveFullUrl(pathOrFull) {
            // If it's already a full URL, use it as is (for custom endpoints)
            if (pathOrFull.startsWith('http://') || pathOrFull.startsWith('https://')) {
                return pathOrFull;
            }
            
            if (currentBackendMode === 'fixed') {
                // In proxy mode, we return just the path - the actual target URL is built in sendApiRequest
                return pathOrFull;
            } else {
                // Local mode - direct to localhost:port
                const base = getCurrentBaseUrl();
                if (pathOrFull.startsWith('/')) {
                    return base + pathOrFull;
                }
                return base + '/' + pathOrFull;
            }
        }

        function renderNav() {
            let navHtml = '';
            customApis.forEach((api, idx) => {
                const displayName = api.name.length > 18 ? api.name.substring(0,16)+'..' : api.name;
                const groupColor = api.group || 'default';
                const protectedClass = api.protected ? 'protected' : '';
                navHtml += `<div class="nav-item ${protectedClass}" data-nav-index="${idx}" title="${api.name}" style="border-left-color: var(--line-${groupColor});"><i class="bi bi-dot"></i> ${displayName}</div>`;
            });
            navContainer.innerHTML = navHtml;

            document.querySelectorAll('.nav-item[data-nav-index]').forEach(item => {
                item.addEventListener('click', (e) => {
                    const idx = e.currentTarget.dataset.navIndex;
                    const card = document.getElementById(`card-${idx}`);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        }

        function toggleAuthPanel(index) {
            customApis[index].showAuth = !customApis[index].showAuth;
            saveApis(customApis);
            renderCards();
            renderNav();
        }

        function duplicateApi(index) {
            const original = customApis[index];
            const copy = JSON.parse(JSON.stringify(original));
            copy.name = original.name + ' (copy)';
            copy.body = '';
            copy.showAuth = false;
            copy.group = original.group;
            copy.protected = false; // Duplicates are never protected
            
            customApis.splice(index + 1, 0, copy);
            
            const newMap = new Map();
            for (let [k, v] of responseMap.entries()) {
                if (k <= index) newMap.set(k, v);
                else newMap.set(k + 1, v);
            }
            responseMap = newMap;
            
            saveApis(customApis);
            renderCards();
            renderNav();
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function renderCards() {
            if (!container) return;
            let html = '';
            
            for (let i = 0; i < customApis.length; i++) {
                const api = customApis[i];
                const methodLower = api.method.toLowerCase();
                const methodClass = `method-${methodLower}`;
                const group = api.group || 'default';
                const isProtected = api.protected === true;
                
                let displayUrl, fullUrl;
                if (api.fullUrl) {
                    fullUrl = api.fullUrl;
                    displayUrl = fullUrl;
                } else {
                    fullUrl = resolveFullUrl(api.path);
                    displayUrl = api.path; // Show only path in input
                }

                const savedResponse = responseMap.get(i) || { text: 'Click "Send" to see response ‚Ä¶', status: null };
                const bodyValue = api.body || '';

                const protectedClass = isProtected ? 'protected' : '';
                html += `<div class="api-row ${protectedClass}" id="card-${i}" data-group="${group}" style="border-left-color: var(--line-${group});">`;
                
                // Header
                html += `<div class="d-flex flex-wrap align-items-center gap-2 mb-2">`;
                html += `<span class="method-badge ${methodClass}"><i class="bi bi-${methodLower === 'post' ? 'file-post' : (methodLower === 'get' ? 'cloud-arrow-down' : (methodLower === 'put' ? 'pencil-square' : 'trash3'))}"></i> ${api.method}</span>`;
                html += `<span class="fw-semibold fs-5">${api.name}</span>`;
                html += `<span class="text-secondary small flex-grow-1">${api.description || ''}</span>`;
                
                // Protected badge for originals
                if (isProtected) {
                    html += `<span class="protected-badge"><i class="bi bi-shield-check"></i> Original</span>`;
                }
                
                // Group badge
                html += `<span class="group-badge" style="background: color-mix(in srgb, var(--line-${group}) 20%, transparent); color: var(--line-${group});"><i class="bi bi-palette"></i> ${group}</span>`;
                
                // Buttons
                html += `<div class="btn-group" role="group">`;
                html += `<button class="btn btn-outline-secondary btn-sm action-btn auth-collapse-btn" data-toggle-auth="${i}"><i class="bi bi-shield-lock"></i> Auth</button>`;
                html += `<button class="btn btn-outline-primary btn-sm action-btn duplicate-btn" data-duplicate-index="${i}"><i class="bi bi-files"></i> Duplicate</button>`;
                
                // Remove button - disabled for protected APIs
                if (isProtected) {
                    html += `<button class="btn btn-outline-danger btn-sm action-btn remove-btn" disabled title="Original API cannot be deleted"><i class="bi bi-lock-fill"></i></button>`;
                } else {
                    html += `<button class="btn btn-outline-danger btn-sm action-btn remove-btn" data-remove-index="${i}"><i class="bi bi-trash"></i></button>`;
                }
                html += `</div>`;
                html += `</div>`;

                // URL row - Show only path in input box
                html += `<div class="d-flex flex-wrap align-items-center gap-2 mb-3">`;
                html += `<select class="form-select method-select rounded-pill w-auto border-2" data-method-index="${i}">`;
                ['GET','POST','PUT','PATCH','DELETE'].forEach(m => {
                    html += `<option value="${m}" ${api.method === m ? 'selected' : ''}>${m}</option>`;
                });
                html += `</select>`;
                html += `<input type="text" class="form-control url-box flex-grow-1" value="${api.fullUrl || api.path}" placeholder="/api/..." data-path-index="${i}">`;
                html += `</div>`;
                
                // Show routing info
                if (currentBackendMode === 'fixed') {
                    html += `<div class="small mb-2"><i class="bi bi-server"></i> <span class="badge bg-info">PROXY MODE</span> ‚Üí via <code>${PROXY_ENDPOINT}</code> ‚Üí target: <span class="text-primary">${targetBackendInput.value || 'your-backend.com'}</span><span class="text-info">${api.path || ''}</span></div>`;
                } else {
                    let base = getCurrentBaseUrl();
                    html += `<div class="small mb-2"><i class="bi bi-hdd"></i> <span class="badge bg-success">DIRECT MODE</span> ‚Üí <span class="text-info">${base}${api.path || ''}</span></div>`;
                }

                // Auth panel
                if (api.showAuth) {
                    html += `<div class="auth-panel">`;
                    html += `<div class="row g-3 align-items-center">`;
                    html += `<div class="col-md-5">`;
                    html += `<label class="fw-semibold small">Authorization:</label>`;
                    html += `<select class="form-select auth-type-select rounded-pill mt-1" data-auth-type="${i}">`;
                    html += `<option value="none" ${api.auth.type === 'none' ? 'selected' : ''}>None</option>`;
                    html += `<option value="bearer" ${api.auth.type === 'bearer' ? 'selected' : ''}>Bearer Token</option>`;
                    html += `<option value="basic" ${api.auth.type === 'basic' ? 'selected' : ''}>Basic Auth</option>`;
                    html += `</select>`;
                    html += `</div>`;
                    html += `<div class="col-md-7">`;
                    html += `<label class="fw-semibold small">Token / credentials:</label>`;
                    html += `<input type="text" class="form-control token-input rounded-pill mt-1" value="${(api.auth.token || '').replace(/</g, '&lt;')}" placeholder="token or user:pass" data-auth-token="${i}">`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `<div class="row mt-3">`;
                    html += `<div class="col-md-12">`;
                    html += `<label class="fw-semibold small me-3">Content-Type:</label>`;
                    html += `<select class="form-select auth-content-type rounded-pill w-50 d-inline-block" data-content-type="${i}">`;
                    ['application/json','application/x-www-form-urlencoded','multipart/form-data','text/plain'].forEach(ct => {
                        html += `<option value="${ct}" ${api.contentType === ct ? 'selected' : ''}>${ct}</option>`;
                    });
                    html += `</select>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                }

                // Body and Response
                html += `<div class="row g-3 mt-1">`;
                html += `<div class="col-md-5">`;
                html += `<label class="form-label fw-semibold small"><i class="bi bi-file-code"></i> Request body (type your JSON)</label>`;
                html += `<textarea class="form-control request-textarea" rows="1" id="body-${i}" data-body-index="${i}" placeholder='{\n  "key": "value"\n}'>${bodyValue.replace(/</g, '&lt;')}</textarea>`;
                html += `<div class="placeholder-hint mt-1 small text-secondary"><i class="bi bi-arrows-expand"></i> Expands with content</div>`;
                html += `</div>`;
                html += `<div class="col-md-7">`;
                html += `<div class="d-flex justify-content-between align-items-center mb-2">`;
                html += `<label class="form-label fw-semibold small mb-0"><i class="bi bi-braces"></i> Response (auto-height)</label>`;
                html += `<button class="btn btn-primary btn-send send-btn shadow-sm" data-index="${i}"><i class="bi bi-send-fill"></i> Send</button>`;
                html += `</div>`;
                let statusBadge = '';
                if (savedResponse.status) {
                    const statusOk = savedResponse.status >= 200 && savedResponse.status < 300;
                    statusBadge = `<span class="badge ${statusOk ? 'bg-success' : 'bg-danger'} ms-2">status ${savedResponse.status}</span>`;
                }
                html += `<pre class="response-pre" id="response-${i}">${savedResponse.text.replace(/</g, '&lt;')} ${statusBadge.replace(/</g, '&lt;')}</pre>`;
                html += `</div>`;
                html += `</div>`;
                html += `</div>`;
            }
            container.innerHTML = html;

            // Auto-resize textareas
            document.querySelectorAll('[data-body-index]').forEach(textarea => {
                const index = textarea.dataset.bodyIndex;
                autoResizeTextarea(textarea);
                
                let timeout;
                textarea.addEventListener('input', (e) => {
                    autoResizeTextarea(e.target);
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        customApis[index].body = e.target.value;
                        saveApis(customApis);
                    }, 300);
                });
            });

            // Send button
            document.querySelectorAll('.send-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const index = e.currentTarget.dataset.index;
                    if (index !== undefined) await sendApiRequest(parseInt(index));
                });
            });

            // Auth toggle
            document.querySelectorAll('[data-toggle-auth]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.dataset.toggleAuth;
                    if (index !== undefined) toggleAuthPanel(parseInt(index));
                });
            });

            // Duplicate button
            document.querySelectorAll('[data-duplicate-index]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.dataset.duplicateIndex;
                    if (index !== undefined) duplicateApi(parseInt(index));
                });
            });

            // Method select
            document.querySelectorAll('.method-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = e.target.dataset.methodIndex;
                    if (index !== undefined) {
                        customApis[index].method = e.target.value;
                        saveApis(customApis);
                        renderCards();
                        renderNav();
                    }
                });
            });

            // Path input
            document.querySelectorAll('[data-path-index]').forEach(input => {
                const update = (e) => {
                    const index = e.target.dataset.pathIndex;
                    if (index !== undefined) {
                        const val = e.target.value;
                        if (val.startsWith('http://') || val.startsWith('https://')) {
                            customApis[index].fullUrl = val;
                            delete customApis[index].path;
                        } else {
                            customApis[index].path = val;
                            delete customApis[index].fullUrl;
                        }
                        saveApis(customApis);
                        renderCards();
                        renderNav();
                    }
                };
                input.addEventListener('blur', update);
                input.addEventListener('keypress', (e) => { if (e.key === 'Enter') e.target.blur(); });
            });

            // Auth type select
            document.querySelectorAll('.auth-type-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = e.target.dataset.authType;
                    if (index !== undefined) {
                        customApis[index].auth.type = e.target.value;
                        saveApis(customApis);
                    }
                });
            });

            // Auth token input
            document.querySelectorAll('[data-auth-token]').forEach(input => {
                input.addEventListener('blur', (e) => {
                    const index = e.target.dataset.authToken;
                    if (index !== undefined) {
                        customApis[index].auth.token = e.target.value;
                        saveApis(customApis);
                    }
                });
            });

            // Content type select
            document.querySelectorAll('.auth-content-type').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = e.target.dataset.contentType;
                    if (index !== undefined) {
                        customApis[index].contentType = e.target.value;
                        saveApis(customApis);
                    }
                });
            });

            // Remove btn - only enabled for non-protected APIs
            document.querySelectorAll('.remove-btn:not([disabled])').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.dataset.removeIndex;
                    if (index !== undefined) {
                        customApis.splice(index, 1);
                        const newMap = new Map();
                        for (let [k, v] of responseMap.entries()) {
                            if (k < index) newMap.set(k, v);
                            else if (k > index) newMap.set(k-1, v);
                        }
                        responseMap = newMap;
                        saveApis(customApis);
                        renderCards();
                        renderNav();
                    }
                });
            });
        }

        // üî• FIXED sendApiRequest function - NOW WORKING WITH PROXY!
        async function sendApiRequest(index) {
            const api = customApis[index];
            if (!api) return;

            const responsePre = document.getElementById(`response-${index}`);
            if (!responsePre) return;

            const bodyTextarea = document.getElementById(`body-${index}`);
            let bodyValue = bodyTextarea ? bodyTextarea.value : '';

            // Validate JSON if needed
            if (bodyValue && bodyValue.trim() !== '' && api.contentType && api.contentType.includes('application/json')) {
                try { 
                    JSON.parse(bodyValue); 
                } catch (jsonErr) {
                    responsePre.innerHTML = `‚ùå INVALID JSON:\n${jsonErr.message}`;
                    responseMap.set(index, { text: `‚ùå INVALID JSON:\n${jsonErr.message}`, status: null });
                    return;
                }
            }

            if (currentBackendMode === 'fixed') {
                // üî• PROXY MODE - Send via proxy server
                await sendViaProxy(index, api, bodyValue, responsePre);
            } else {
                // üî• DIRECT MODE - Send directly to localhost
                await sendDirect(index, api, bodyValue, responsePre);
            }
        }

        // New function for proxy mode
        async function sendViaProxy(index, api, bodyValue, responsePre) {
            try {
                // Get target backend URL from input
                let targetBackendBase = targetBackendInput.value.trim();
                if (!targetBackendBase) {
                    targetBackendBase = 'https://your-backend.onrender.com'; // fallback
                }
                
                // Remove trailing slash if present
                targetBackendBase = targetBackendBase.replace(/\/$/, '');
                
                // Build the target URL
                let targetUrl;
                if (api.fullUrl) {
                    targetUrl = api.fullUrl; // Custom full URL
                } else {
                    // Ensure path starts with /
                    const path = api.path.startsWith('/') ? api.path : '/' + api.path;
                    targetUrl = targetBackendBase + path;
                }

                responsePre.innerHTML = `‚è≥ Proxying request to: ${targetUrl} ...`;

                // Prepare headers
                const headers = {};
                if (api.contentType) {
                    headers['Content-Type'] = api.contentType;
                }
                
                // Add auth headers
                if (api.auth.type === 'bearer' && api.auth.token) {
                    headers['Authorization'] = `Bearer ${api.auth.token}`;
                } else if (api.auth.type === 'basic' && api.auth.token) {
                    headers['Authorization'] = `Basic ${btoa(api.auth.token)}`;
                }

                // Prepare proxy payload
                const proxyPayload = {
                    url: targetUrl,
                    method: api.method,
                    headers: headers
                };

                // Add body for applicable methods
                if (bodyValue && bodyValue.trim() !== '' && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(api.method)) {
                    proxyPayload.body = bodyValue;
                }

                // Send to proxy
                const start = performance.now();
                const proxyResponse = await fetch(PROXY_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(proxyPayload)
                });

                const responseData = await proxyResponse.json();
                const timeMs = Math.round(performance.now() - start);

                let displayText = '';
                if (responseData.success) {
                    // Format the response nicely
                    const responseContent = responseData.data || responseData;
                    displayText = `‚úÖ [${responseData.status || 200}] ${timeMs}ms\n${JSON.stringify(responseContent, null, 2)}`;
                } else {
                    displayText = `‚ö†Ô∏è [${responseData.status || 500}] ${timeMs}ms\nError: ${responseData.error || 'Unknown'}\n${JSON.stringify(responseData, null, 2)}`;
                }

                responsePre.innerHTML = displayText.replace(/</g, '&lt;');
                responseMap.set(index, { 
                    text: displayText, 
                    status: responseData.status || (responseData.success ? 200 : 500) 
                });

            } catch (error) {
                const errMsg = `üí• PROXY ERROR: ${error.message}`;
                responsePre.innerHTML = errMsg.replace(/</g, '&lt;');
                responseMap.set(index, { text: errMsg, status: null });
            }
        }

        // Direct mode (original functionality)
        async function sendDirect(index, api, bodyValue, responsePre) {
            try {
                // Build URL
                let url;
                if (api.fullUrl) {
                    url = api.fullUrl;
                } else {
                    const base = getCurrentBaseUrl();
                    const path = api.path.startsWith('/') ? api.path : '/' + api.path;
                    url = base + path;
                }

                responsePre.innerHTML = `‚è≥ Sending direct request to: ${url} ...`;

                // Prepare headers
                const headers = { 'Accept': 'application/json, text/plain, */*' };
                if (api.contentType) {
                    headers['Content-Type'] = api.contentType;
                }
                
                // Add auth headers
                if (api.auth.type === 'bearer' && api.auth.token) {
                    headers['Authorization'] = `Bearer ${api.auth.token}`;
                } else if (api.auth.type === 'basic' && api.auth.token) {
                    headers['Authorization'] = `Basic ${btoa(api.auth.token)}`;
                }

                const fetchOptions = { 
                    method: api.method, 
                    headers, 
                    mode: 'cors' 
                };

                // Add body for applicable methods
                if (bodyValue && bodyValue.trim() !== '' && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(api.method)) {
                    fetchOptions.body = bodyValue;
                }

                const start = performance.now();
                const fetchResponse = await fetch(url, fetchOptions);
                const status = fetchResponse.status;
                
                const resContentType = fetchResponse.headers.get('content-type') || '';
                let responseText;
                
                if (resContentType.includes('application/json')) {
                    try { 
                        responseText = JSON.stringify(await fetchResponse.json(), null, 2); 
                    } catch { 
                        responseText = await fetchResponse.text(); 
                    }
                } else {
                    responseText = await fetchResponse.text();
                }
                
                const timeMs = Math.round(performance.now() - start);
                const final = `${status >= 200 && status < 300 ? '‚úÖ' : '‚ö†Ô∏è'} [${status}] ${timeMs}ms\n${responseText}`;
                
                responsePre.innerHTML = final.replace(/</g, '&lt;');
                responseMap.set(index, { text: final, status });

            } catch (error) {
                const errMsg = `üí• DIRECT ERROR: ${error.message}`;
                responsePre.innerHTML = errMsg.replace(/</g, '&lt;');
                responseMap.set(index, { text: errMsg, status: null });
            }
        }

        function addNewApi() {
            const name = prompt('Enter endpoint name (e.g., "Logout"):', 'üÜï Custom');
            if (name === null) return;
            customApis.push({
                name: name.trim() || 'Custom',
                method: 'GET',
                path: '/api/custom',
                description: 'user defined',
                body: '',
                auth: { type: 'none', token: '' },
                contentType: 'application/json',
                showAuth: false,
                group: 'default',
                protected: false // User-added APIs are not protected
            });
            saveApis(customApis);
            renderCards();
            renderNav();
        }

        addApiNavBtn.addEventListener('click', addNewApi);
        
        // Update when port input changes
        portInput.addEventListener('input', () => { 
            if (currentBackendMode === 'local') {
                renderCards(); 
                renderNav(); 
            }
        });

        // Update when target backend changes
        targetBackendInput.addEventListener('input', () => {
            if (currentBackendMode === 'fixed') {
                renderCards();
            }
        });

        renderCards();
        renderNav();
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>
</html>
